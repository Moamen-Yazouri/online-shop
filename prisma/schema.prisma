// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum Role {
  CUSTOMER
  MERCHANT
  ADMIN
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum ReturnStatus {
  PICKED
  REFUND
  PENDING
}

enum TxType {
  DEBIT   // money leaving the user (purchase)
  CREDIT  // money to the user (refund/top-up)
}

model User {
  id        BigInt   @id @default(autoincrement())
  name      String
  email     String   @unique
  role      Role     @default(CUSTOMER)
  password String    @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  orders    Order[]
  products  Product[]     @relation("MerchantProducts") // if a user can be a merchant
  txns      User_Transaction[]

  @@index([role])
}

model Product {
  id          BigInt   @id @default(autoincrement())
  name        String
  description String?
  price       Decimal   @db.Decimal(12,2) // current list price
  merchantId  BigInt?   @map("merchant_id")

  
  merchant    User?     @relation("MerchantProducts", fields: [merchantId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  orderItems  Order_Product[]
  returnItems Return_Item[]

  @@index([merchantId])
}

model Order {
  id          BigInt       @id @default(autoincrement())
  userId      BigInt       @map("user_id")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  orderStatus OrderStatus  

  user        User         @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  items       Order_Product[]
  returns     Order_Return[]
  txns        User_Transaction[]

  @@index([userId])
  @@index([orderStatus])
}

model Order_Product {
  // snapshot of price at purchase + quantity
  orderId   BigInt @map("order_id")
  productId BigInt @map("product_id")
  price     Decimal  @db.Decimal(12,2)
  quantity  Int

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@id([orderId, productId]) // composite PK for the junction
  @@index([productId])
}

model Order_Return {
  id        BigInt       @map("order_return_id") @id @default(autoincrement())
  orderId   BigInt        @map("order_id")
  status    ReturnStatus 
  createdAt DateTime     @default(now())

  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  items     Return_Item[]
  txns      User_Transaction[]

  @@index([orderId])
  @@index([status])
}

model Return_Item {
  // which products (and how many) are being returned in a particular return
  orderReturnId BigInt @map("order_return_id")
  productId     BigInt @map("product_id")
  quantity      Int

  orderReturn   Order_Return @relation(fields: [orderReturnId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product       Product      @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@id([orderReturnId, productId]) // composite PK per-return
  @@index([productId])
}

model User_Transaction {
  id             BigInt    @id @default(autoincrement())
  userId         BigInt    @map("user_id")
  amount         Decimal   @db.Decimal(12,2)
  type           TxType
  orderId        BigInt?   @map("order_id")  // nullable: top-ups, adjustments, etc.
  orderReturnId  BigInt?   @map("order_return_id")

  user           User         @relation(fields: [userId],        references: [id], onDelete: Restrict, onUpdate: Cascade)
  order          Order?       @relation(fields: [orderId],       references: [id], onDelete: SetNull,  onUpdate: Cascade)
  orderReturn    Order_Return?@relation(fields: [orderReturnId], references: [id], onDelete: SetNull,  onUpdate: Cascade)

  @@index([userId])
  @@index([orderId])
  @@index([orderReturnId])
  @@index([type])
}

