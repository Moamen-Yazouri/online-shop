

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum Role {
  CUSTOMER
  MERCHANT
  ADMIN
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum ReturnStatus {
  PICKED
  REFUND
  PENDING
}

enum TxType {
  DEBIT   
  CREDIT  
}

enum StorageProviderName {
  IMAGE_KIT
}

model User {
  id        BigInt   @id @default(autoincrement())
  name      String
  email     String   @unique
  role      Role     @default(CUSTOMER)
  password String    @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isDeleted Boolean  @default(false) @map("is_deleted")
  orders    Order[]
  products  Product[]     @relation("MerchantProducts") // if a user can be a merchant
  txns      UserTransaction[]

  @@index([role])
}

model Product {
  id          BigInt   @id @default(autoincrement())
  name        String
  description String?
  price       Decimal   @db.Decimal(12,2) 
  merchantId  BigInt?   @map("merchant_id")
  isDeleted Boolean     @default(false) @map("is_deleted")
  assets       Asset[]  
  merchant    User?     @relation("MerchantProducts", fields: [merchantId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  orderItems  OrderProduct[]
  returnItems ReturnItem[]

  @@index([merchantId])
}


model Asset {
  id                   BigInt                 @id @default(autoincrement()) 
  storageProviderName  StorageProviderName    @default(IMAGE_KIT) @map("storage_provider_name")
  fileId               String                 @db.VarChar(255)
  url                  String                 @db.VarChar(255)
  fileType             String                 @db.VarChar(255)
  fileSizeInKB         Int                    @db.UnsignedInt
  createdAt            DateTime               @default(now())    @map("created_at")
  deletedAt            DateTime?              @map("deleted_at")
  productId            BigInt?                @map("product_id")

  // Relations
  product  Product?                           @relation(fields: [productId], references: [id])

  @@map("assets")
}

model Order {
  id          BigInt       @id @default(autoincrement())
  userId      BigInt       @map("user_id")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  orderStatus OrderStatus  

  user        User         @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  items       OrderProduct[]
  returns     OrderReturn[]
  txns        UserTransaction[]

  @@index([userId])
  @@index([orderStatus])
}

model OrderProduct {
  // snapshot of price at purchase + quantity
  orderId   BigInt @map("order_id")
  productId BigInt @map("product_id")
  price     Decimal  @db.Decimal(12,2)
  quantity  Int

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@id([orderId, productId]) // composite PK for the junction
  @@index([productId])
}

model OrderReturn {
  id        BigInt       @map("order_return_id") @id @default(autoincrement())
  orderId   BigInt        @map("order_id")
  status    ReturnStatus 
  createdAt DateTime     @default(now())

  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  items     ReturnItem[]
  txns      UserTransaction[]

  @@index([orderId])
  @@index([status])
}

model ReturnItem {

  orderReturnId BigInt @map("order_return_id")
  productId     BigInt @map("product_id")
  quantity      Int

  orderReturn   OrderReturn @relation(fields: [orderReturnId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product       Product      @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@id([orderReturnId, productId]) // composite PK per-return
  @@index([productId])
}

model UserTransaction {
  id             BigInt    @id @default(autoincrement())
  userId         BigInt    @map("user_id")
  amount         Decimal   @db.Decimal(12,2)
  type           TxType
  orderId        BigInt?   @map("order_id")  // nullable: top-ups, adjustments, etc.
  orderReturnId  BigInt?   @map("order_return_id")

  user           User         @relation(fields: [userId],        references: [id], onDelete: Restrict, onUpdate: Cascade)
  order          Order?       @relation(fields: [orderId],       references: [id], onDelete: SetNull,  onUpdate: Cascade)
  orderReturn    OrderReturn?@relation(fields: [orderReturnId], references: [id], onDelete: SetNull,  onUpdate: Cascade)

  @@index([userId])
  @@index([orderId])
  @@index([orderReturnId])
  @@index([type])
}





